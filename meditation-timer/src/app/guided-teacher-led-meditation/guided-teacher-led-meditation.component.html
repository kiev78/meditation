<div class="guided-container">
  <div *ngIf="selected; else loading" class="content">
    <h3>{{ selected.title }}</h3>
    <p *ngIf="selected.teacher"><strong>{{ selected.teacher }}</strong></p>

    <div *ngIf="loadError" class="error-message">
      <p>Failed to load audio file. The file may not exist or is unreachable.</p>
    </div>

    <div class="timeline-row">
      <span class="time-text">{{ formatTime(currentTime) }}</span>
      <mat-slider
        [min]="0"
        [max]="totalDuration"
        step="1"
        [displayWith]="formatLabel"
        class="timeline-slider"
      >
        <input matSliderThumb [value]="currentTime" (change)="seek($event)" />
      </mat-slider>
      <span class="time-text">{{ formatTime(totalDuration) }}</span>
    </div>

    <div class="button-row">
      <button mat-icon-button (click)="skipBack()">
        <mat-icon>replay_10</mat-icon>
      </button>

      <button mat-fab color="primary" (click)="togglePlay()" [disabled]="!audioReady || loadError">
        <ng-container *ngIf="timerService.state$ | async as state">
          <ng-container *ngIf="state.isRunning; else showPlay">
             <!-- If running and in negative phase (delay/bells), show countdown number -->
             <span *ngIf="state.remainingTime < 0" class="fab-countdown">
               {{ state.remainingTime * -1 }}
             </span>
             <!-- If running and positive time, show Pause icon -->
             <mat-icon *ngIf="state.remainingTime >= 0">pause</mat-icon>
          </ng-container>
          <ng-template #showPlay>
            <mat-icon>play_arrow</mat-icon>
          </ng-template>
        </ng-container>
      </button>

      <button mat-icon-button (click)="skipForward()">
        <mat-icon>forward_10</mat-icon>
      </button>

      <!-- Next Button triggers parent cycle -->
      <button mat-icon-button (click)="onNext()">
        <mat-icon>skip_next</mat-icon>
      </button>
    </div>
  </div>

  <ng-template #loading>
    <p>Loading meditationsâ€¦</p>
  </ng-template>
</div>
